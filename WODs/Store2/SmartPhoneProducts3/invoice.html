<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./product_data.js"></script>
    <script>
      //query string params from products_display.html
      let params = (new URL(document.location)).searchParams;
      quantities = [];

      for (let i = 0; i < products.length; i++) {
  let quantity = params.get(`quantity${i}`);
  quantities.push(quantity); // Push the quantity variable, not the quantities array
};

       // Compute subtotal 
       let subtotal= 0;
       let errors = []; // Initialize errors array
       function isNonNegInt(quantities){
           errors = [];
           // assume no errors at first 
           if(Number(quantities) != quantities) errors.push('Not a number!');
           // chceck if string is a number value 
           if(quantities < 0) errors.push('Negative value!');
           // Check if it is non-negative 
           if(parseInt(quantities) != quantities) errors.push('Not an Integer!');
           // check that is is an integer
           return(errors.length == 0);
       };

       // generate item row function
       function generate_item_rows(){
           // Clear subtotal before calculation
           subtotal = 0;
           // item rows 
           for(let i in quantities){
               let extended_price = quantities[i] * products[i].price;
               if(quantities[i] == 0){
                   continue;
               } else {
                   // callback
                   isNonNegInt(quantities[i]);
                   if(errors.length != 0){
                       extended_price = 0;
                   }
                   // check that a quantity is valid before writing the table row
                   document.write(`
                       <tr>
                           <td width="43%">${products[i].brand}</td>
                           <td align="center" width="11%">${quantities[i]}</td>
                           <td width="13%">\$${products[i].price.toFixed(2)}</td>
                           <td width="54%">$${extended_price.toFixed(2)}</td>
                       </tr>
                   `);
               }
               // subtotal += exteneded price 
               subtotal += extended_price;
           };
       };
    </script>
</head>
<body>
    <table border="2">
        <tbody>
            <tr>
                <th style="text-align: center;" width="43%">Item</th>
                <th style="text-align: center;" width="11%">Quantity</th>
                <th style="text-align: center;" width="13%">Price</th>
                <th style="text-align: center;" width="54%">Extended Price</th>
            </tr>
            <script>
                // Call function to generate item rows
                generate_item_rows(quantities);
                
                // Compute taxrate
                let taxrate = 0.0575;
                let tax = subtotal * taxrate;
                
                // Compute Shipping
                let shipping;
                if (subtotal <= 49.99) {
                    shipping = 2;
                } else if (subtotal <= 99.99) {
                    shipping = 5;
                } else {
                    shipping = 0.05 * subtotal;
                }
                
                // Compute Grandtotal 
                let total = subtotal + tax + shipping;
            </script>
            <tr>
                <td colspan="4" width="100%">&nbsp;</td>
            </tr>
            <tr>
                <td style="text-align: center;" colspan="3" width="67%">Sub-total</td>
                <td width="54%">$<script>document.write(subtotal.toFixed(2))</script></td>
            </tr>
            <tr>
                <td style="text-align: center;" colspan="3" width="67%"><span style="font-family: arial;">Tax @ <script>document.write(100 * taxrate)</script></span></td>
                <td width="54%">$<script>document.write(tax.toFixed(2))</script></td>
            </tr>
            <tr>
                <td style="text-align: center;" colspan="3" width="67%">Shipping</td>
                <td width="54%">$<script>document.write(shipping.toFixed(2))</script></td>
            </tr>
            <tr>
                <td style="text-align: center;" colspan="3" width="67%"><strong>Total</strong></td>
                <td width="54%"><strong>$<script>document.write(total.toFixed(2))</script></strong></td>
            </tr>
        </tbody>
    </table>
    <div>
        <br><b>
        OUR SHIPPING POLICY IS:A subtotal $0 - $49.99 will be $2 shipping<br>
        A subtotal $50 - $99.99 will be $5 shipping<br>
        Subtotals over $100 will be charged 5% of the subtotal amount<br>
        </b></br>
    </div>
</body>
</html>
